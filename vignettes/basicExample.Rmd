---
title: "Basic Examples for qpModel"
author: "Brett Matzuka"
output: html_document
vignette: >
  %\VignetteIndexEntry{Basic Examples for qpModel}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(ggplot2)
library(mrgsolve)
library(qpModel)

```


# Create a Custom PK model

This allows the user to custom define a model and turn it into a mrgsolve simulation-ready model.

## Create

```{r}

baseModel <- qpmodel(
  ode = eqns(
    Aabs = -ka*Aabs, 
    Acentral = ka*Aabs - (cl/V)*Acentral
  ),
  param = eqns(
    ka = exp(tvka+etaka),
    cl = exp(tvcl+etacl),
    V = tvV + etaV
  ),
  theta = eqns(
    tvka = 0.2, 
    tvcl = 1, 
    tvV = 20
  ),
  omega = eqns(
    etaka = 0.1, 
    etacl = 0.2, 
    etaV = 0.3
  ),
  sigma = eqns(
    ADD = 0.2, 
    PROP = 0.2
  ),
  observe = eqns(
    IPRED = Acentral/V, DV = IPRED*(1+PROP)+ADD
  ), 
  output = eqns(
    IPRED, DV
  )
)

baseModel

```


Create a Rcpp model mrgsolve and load it.

```{r}

mrg <- baseModel %>% as_mrgsolve

mod <- mread(model = "pkmodel", code = mrg)

# equivalently:

mod <- 'pkmodel' %>% mcode(mrg)

```

## Simulate

```{r}
data <- 
  data.frame("ID" = 1:100) %>%
  mutate(
    evid = 1,
    cmt = 1,
    amt = 100,
    time = 0,
    etacl = 0
  )

out <- mod %>%
  data_set(data) %>%
  mrgsim(
    end = 24,
    delta = 0.1, 
    obsonly = TRUE
  ) %>%
  as.data.frame
```

## Plot
```{r}
ggplot(out,aes(x=time,y=IPRED,group=ID)) + 
  #geom_point() + 
  geom_line() + 
  theme_classic() + 
  xlab("Time (hr)") + 
  ylab("Concentration")

```

# Use Blocks to Create a Model
## Create

```{r}

twocpt <- qp.twocpt.iv.cl()
absMM <- qp.abs.MM()

model <- 
  twocpt + 
  absMM + 
  theta(
    tvV = 2, 
    tvCL = 3, 
    tvQ = 0.5, 
    tvV2 = 0.1, 
    tvamax = 0.35, 
    tvka50 = 0.05
  ) + 
  omega(
    etaV = 0.1, 
    etaCL = 0.2, 
    etaQ = 0, 
    etaV2 = 0, 
    etaamax = 0,
    etaka50 = 0.1
  ) 

mrg <- model %>% as_mrgsolve

modnew <- 'pkmodel2' %>% mcode(mrg)

```
## Simulate

```{r}
data <- 
  data.frame("ID" = 1:100) %>%
  mutate(
    evid = 1,
    cmt = 3,
    amt = 100,
    time = 0,
    etacl = 0
  )

out <- modnew %>%
  data_set(data) %>%
  mrgsim(
    end = 24*7, 
    delta = 0.1, 
    obsonly=TRUE
  ) %>%
  as.data.frame
```

## Plot
```{r}
ggplot(out,aes(x=time,y=IPRED,group=ID)) + 
  #geom_point() + 
  geom_line() + 
  theme_classic() + 
  xlab("Time (hr)") + 
  ylab("Concentration")

```


# TCAM Model Development
## Create

```{r}

tcammodel <- 
  qp.twocpt.iv.cl() + 
  qp.abs.TCAM() + 
  theta(
    tvV = 4.6, 
    tvCL = 3.54, 
    tvQ = 4.06, 
    tvV2 = 3.5, 
    tvmtt = 0.15, 
    tvntr = -0.065, 
    tvf1 = 0.9
  )

mrg <- tcammodel %>% as_mrgsolve

tcammod <- 'tcam' %>% mcode(mrg)

```

## Simulate

```{r}
data <- 
  data.frame("ID" = 1:100) %>%
  mutate(
    evid = 1,
    cmt = 1,
    Amt = 80*1000,
    amt = 80*1000,
    time = 0,
    etacl = 0
  )

out <- tcammod %>%
  data_set(data) %>%
  mrgsim(
    end = 24*1, 
    delta = 0.1, 
    obsonly = TRUE
  ) %>%
  as.data.frame

```

## Plot

```{r}

ggplot(out,aes(x=time,y=IPRED,group=ID)) + 
  #geom_point() + 
  geom_line() + 
  theme_bw() + 
  xlab("Time (hr)") + 
  ylab("Concentration")
```

# Three Compartments with First-order and Zero-order Absorption
## Create

```{r}
threecpt <- 
  qp.threecpt.oral.cl() +
  theta(
    tvV = 86.0799, 
    tvV2 = 40.5079, 
    tvCL = 22.8508, 
    tvQ = 1.43427, 
    tvQ2 = 1.68378, 
    tvV3 = 12.9983
  ) + 
  parameter(
    CL = tvCL*exp(etaCL),
    V = tvV, 
    V2 = tvV2*exp(etaV2), 
    Q = tvQ*exp(etaQ), 
    V3 = tvV3, 
    Q2 = tvQ2
  ) + 
  qp.abs.zero.and.first.order()

# just for fun, how would this look as NONMEM code?
threecpt %>% as_nonmem %>% writeLines

# back to simulation ...
mrg <- threecpt %>% as_mrgsolve

threecptmod <- 'threecpt' %>% mcode(mrg)

```

## Simulate

```{r}

data <- 
  data.frame("ID" = 1) %>%
  mutate(
    evid = 1,
    cmt = 1,
    amt = 1657*10,
    time = 0
  )

out <- threecptmod %>%
  data_set(data) %>%
  mrgsim(
    end = 24*1,
    delta = 0.1,
    obsonly = TRUE
  ) %>% 
  as.data.frame

```

## Plot

```{r}

ggplot(out,aes(x=time,y=IPRED,group=ID)) + 
  #geom_point() + 
  geom_line() + 
  theme_bw() + 
  xlab("Time (hr)") + 
  ylab("Concentration")

```
